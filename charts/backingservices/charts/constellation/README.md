# Constellation UI

With Infinity 8.8 we have separated the Constellation UI content and its delivery into 2 categories:

1. **JS generated by Pega engineers** - This is the js that takes the UI metadata and case values and builds the presentation on the client, and then manages interactions between the browser and the case engine. It is exactly the same for all customers, and tightly bound to the Infinity V2DxAPI's. We publish this to a Pega CDN, and all Cosmos React portals automatically load the Pega generated js from there.
2. **UI assets** - Images, Custom components, Localisations authored by customers. As customers author their applications, they add customer and application specific UI assets to the presentation. These assets are stored in the Constellation Application Static Content Service.

**Versioning**
All of the client side js is versioned as a complete package, and matched with Infinity. All versions are managed within the CDN, with each js request including the required version.

## CDN setup in Infinity
The Infinity DSS ConstellationPegaStaticURL should be set to https://release.constellation.pega.io

With this set, Constellation applications can be authored and run.

This minimal setup has the restriction that custom images, custom components and localisations cannot be added to the application. The next step is the app-static service that handles the customer application specific content. The app-static service can be setup using the ConstellationUI helm chart described below.

## ConstellationUI helm chart

The ConstellationUI helm chart is used to deploy an instance of app-static service into a Kubernetes environment. The service is capable of serving multiple client environments. We encourage having a single deployment for all your systems. The following readme provides a detailed description of the parameter configurations and their default values as applicable. 

#### Prerequisites
#### AWS Cloud 
1. The ConstellationUI helm chart for AWS provider uses an application load balancer to expose the service. Before installing the constellationui helm chart please follow the prerequisites section of the following AWS documentation and make sure your cluster is configured accordingly. 

2. If you are using a custom domain please make sure you have a valid certificate imported or created in ACM.

> https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html

#### Constellationui runtime configuration

The values.yaml file provides configuration options to define the values for the deployment resources of the constellationui service.

#### Configuration settings

| Configuration                           | Usage                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|-----------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `enabled`                               | Enables the constellationui service. Set to true to enable constellationui service in the kubernetes environment.                                                                                                                                                                                                               |
| `cloudProvider`                        | Specify the cloud provider details. Accepted values are aws and gcp.                                                                                                                                                                                                                                                                                          |
| `awsCertificateArn`                        | Specify the arn for the AWS ACM certificate. Accepted values are aws and gcp.                                                                                                                                                                                                                                                                                          |
| `domainName`                        | Specify your custom domain.                                                                                                                                                                                                                                                                                          |
| `docker`.`registry`.`url`                        | Specify the image registry url.                                                                                                                                                                                                                                                                                          |
| `docker`.`registry`.`username`                        | Specify the username for the docker registry.                                                                                                                                                                                                                                                                                          |
| `docker`.`registry`.`password`                        | Specify the password for the docker registry.                                                                                                                                                                                                                                                                                          |
| `docker`.`constellation`.`image`                        | Specify the image version.                                                                                                                                                                                                                                                                                          |

Example:

```yaml
enabled: true
deployment:
  name: "constellation"
# Cloud provider details. Accepted values are aws or gcp
cloudProvider: aws
# For aws cloud provider enter your acm certificate ARN here.
awsCertificateArn : arn:aws:acm:us-west-2:xxxxx:certificate/xxxxxxx
domainName: YOUR_CUSTOM_DOMAIN_HERE
# Docker repos and tag for image
docker:
    # If using a custom Docker registry, supply the credentials here to pull Docker images.
    registry:
      url: YOUR_REGISTRY_URL_HERE
      username: YOUR_REGISTRY_USERNAME_HERE
      password: YOUR_REGISTRY_PASSWORD_HERE
    # Docker image information for the Pega docker image, containing the application server.
    constellation:
      image: cirrus-docker.jfrog.io/constellation-appstatic-service/docker-image:1.0.8-20221228123724
logLevel: info
urlPath: /c11n
replicas: 1
livenessProbe:
  initialDelaySeconds: 5
  timeoutSeconds: 5
  periodSeconds: 30
  successThreshold: 1
  failureThreshold: 3
readinessProbe:
  initialDelaySeconds: 5
  timeoutSeconds: 5
  periodSeconds: 30
  successThreshold: 1
  failureThreshold: 3
```

#### Constellationui helm charts installation steps

1. Create a namespace into which you want to deploy the constellation app-static service
    > kubectl create namespace <<namespace_name_here>>

2. Install the constellation helm charts using the following command 
    > helm install path-to-pega-helm-charts/charts/backingservices/charts/constellation --values path-to-pega-helm-charts/backingservices/charts/constellation/values.yaml -n <<namespace>> --generate-name

3. Once the charts are deployed an application load balancer should be created automatically. You can then configure the records of your custom domain to route to the loadbalancer accordingly. For AWS a simple Route53 record in the correct hosted zone of your custom domain should do it. 

